# Note: this playbook can not run independently
- hosts: "{{ NODE_TO_ADD }}"
  tasks:
  - name: 设置 k8s_nodename 在 master、node 节点 /etc/hosts 地址解析
    lineinfile:
      dest: /etc/hosts
      state: present
      regexp: "{{ K8S_NODENAME }} .* generated by kubeasz"
      line: "{{ inventory_hostname }}    {{ K8S_NODENAME }} # generated by kubeasz"
    delegate_to: "{{ item }}"
    with_items: ["{{ groups.kube_master }}", "{{ groups.kube_node }}"]
    when: "inventory_hostname != K8S_NODENAME"

- hosts: "{{ NODE_TO_ADD }}" 
  roles:
  - { role: os-harden, when: "OS_HARDEN|bool" }
  - { role: chrony, when: "groups['chrony']|length > 0" } 
  - prepare
  - { role: docker, when: "CONTAINER_RUNTIME == 'docker'" }
  - { role: containerd, when: "CONTAINER_RUNTIME == 'containerd'" }
  - kube-lb
  - kube-node
  - { role: calico, when: "CLUSTER_NETWORK == 'calico'" }
  - { role: cilium, when: "CLUSTER_NETWORK == 'cilium'" }
  - { role: flannel, when: "CLUSTER_NETWORK == 'flannel'" }
  - { role: kube-router, when: "CLUSTER_NETWORK == 'kube-router'" }
  - { role: kube-ovn, when: "CLUSTER_NETWORK == 'kube-ovn'" }
